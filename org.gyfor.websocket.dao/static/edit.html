<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>WebSocket Test 2</title>
</head>
<body>
<h2>WebSocket Test</h2>

<div id="party-select"></div>

<input list="partyDescriptions" name="party">
<datalist id="partyDescriptions">
</datalist>

<a href="javascript:doSend('descriptions')">Describe all</a>
<br>
<a href="javascript:doSend('close')">Close</a>

<script type="text/javascript">
	var wsUri = "ws://localhost:8080/ws/entity/party";
	var output;

	function init() {
		output = document.getElementById("party-select");
		testWebSocket();
	}

	function testWebSocket() {
		websocket = new WebSocket(wsUri);
		websocket.onopen = function(evt) {
			onOpen(evt)
		};
		websocket.onclose = function(evt) {
			onClose(evt)
		};
		websocket.onmessage = function(evt) {
			onMessage(evt)
		};
		websocket.onerror = function(evt) {
			onError(evt)
		};
	}

	function onOpen(evt) {
		writeToScreen("CONNECTED");
		//doSend("WebSocket rocks");
	}

	function onClose(evt) {
		writeToScreen("DISCONNECTED");
	}

	function onMessage(evt) {
		writeToScreen('<span style="color: blue;">RESPONSE: ' + evt.data + '</span>');
		// Split on the middot character
		let args = evt.data.split('|');
		switch (args[0]) {
		case "html" :
			let id = args[1];
			let target = document.getElementById(id);
			if (target) {
			    let template = document.createElement('template');
			    template.innerHTML = args[2];
				target.parentNode.replaceChild(template.content.firstChild, target);
			}
			break;
	    default :
	    	alert ("Un-recognised message name: " + args[0]);
	        break;
		}
	}

	function onError(evt) {
		writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data);
	}

	function doSend(message) {
		writeToScreen("SENT: " + message);
		websocket.send(message);
	}

	function writeToScreen(message) {
		var pre = document.createElement("p");
		pre.style.wordWrap = "break-word";
		pre.innerHTML = message;
		output.appendChild(pre);
	}

	window.addEventListener("load", init, false);
</script>

</body>
</html>
