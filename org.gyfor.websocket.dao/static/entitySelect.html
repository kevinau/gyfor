<!DOCTYPE html>
<html>
<head>
  <title>Test entitySelect</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="reset.css" />
  <style>
  /* for testing */
body { 
  margin:20px; 
}

*:focus {
    outline: none;
}

.searchInput {
  position: relative;
  top: 0;
  left: 0;
  font-family: Hevetica, Arial, sans-serif;
  z-index: = 10;
}
.searchInput input.visible {
  position: absolute;
  top: 0;
  left: 0;
  height: 20px;
  font-size: 14px;
  background: transparent;
  border: 1px solid #888888;
  padding: 4px 10px;
  margin: 0;
  z-index: 2;
}
.searchInput input.visible:focus {
  xxxbox-shadow: 0px 0px 1px 1px rgba(0,0,0,0.5);
  border: 1px solid rgba(255, 140, 0, 1);
}

.searchInput input.hidden {
  position: absolute;
  left -9999px;
  display: none;
}
.searchInput div.inputBackground {
  position: absolute;
  top: 0;
  left: 0;
  height: 20px;
  font-size: 14px;
  border: 1px solid transparent;
  padding: 4px 10px;
  margin: 0;
  z-index: 1;
  text-overflow: ellipsis;
  overflow: hidden;
  white-space: nowrap;
}
.searchInput div.inputBackground span {
  font-size: 14px;
  color: #AAAAAA;
  line-height: 20px;
  z-index: 1;
}
.searchInput div.dropList {
  display: none;
  position: absolute;
  top: 30px;
  left: 0;
  border: 1px solid rgba(255, 140, 0, 1);
  z-index: 100;
  cursor: pointer;
}
.searchInput div.dropList.calcSize div {
  display: block !IMPORTANT;
}
.searchInput > div.dropList.calcSize {
  display: block !IMPORTANT;
  position: absolute;
  left: -9999px;
}
.searchInput.active div.dropList.allShowing,
.searchInput.active div.dropList.someShowing {
  display: block;
}

.searchInput.active div.dropList.allShowing div {
  display: block;
}
.searchInput.active div.dropList.someShowing div {
  display: none;
}
.searchInput.active div.dropList.someShowing div.show {
  display: block;
}
.searchInput.active div.dropList>div {
  font-size: 14px;
  padding: 4px 10px;
}
.searchInput.active div.dropList>div:hover {
  background-color: rgba(255, 140, 0, 0.25);
}
.searchInput.active div.dropList>div.highlight {
  background-color: rgba(255, 140, 0, 0.5);
}

.searchInput button.upDownButton {
  display: none;
}
.searchInput.active button.upDownButton {
  display: block;
  position: absolute;
  top: 0;
  left: 0; 
  width: 24px;
  height: 24px;
  cursor: pointer;
  outline: none;
  user-select: none;
  padding: 0;
  margin: 0;
  border: none;
}
.searchInput.active button.upDownButton:before {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: block;
  width: 24px;
  height: 24px;
  content: url(downArrow.svg);
}
.searchInput.active button.upDownButton:disabled {
  cursor: default;
}
.searchInput.active button.upDownButton:disabled:before {
  opacity: 0.4;
}
.searchInput.active button.upDownButton.up:before {
  content: url(upArrow.svg);
}
.searchInput.active button.upDownButton.upAndFilter:before {
  content: url(upAndFilter.svg);
}
  </style>
  <script>
function setToggleButton (e, checked) {
	let toggleButton = e.parentElement.querySelector("button.upDownButton");
	let dropList = e.parentElement.querySelector("div.dropList");
	let dropListItems = dropList.children;

	let n = countShowing(dropList);
	console.log("setToggle button: " + checked + " " + n);
	if (checked) {
		if (n == 0) {
    		toggleButton.checked = true; 
			toggleButton.classList.remove("upAndFilter")
			toggleButton.classList.add("up");
			toggleButton.disabled = false;
			toggleButton.setAttribute("title", "Hide all");
		} else {
    		toggleButton.checked = true; 
			toggleButton.classList.remove("up");
			toggleButton.classList.add("upAndFilter")
			toggleButton.disabled = false;
			toggleButton.setAttribute("title", "Filter");
		}			
	} else {
		if (n == dropListItems.length) {
    		toggleButton.checked = true; 
			toggleButton.classList.remove("up", "upAndFilter");
			toggleButton.disabled = true;
			toggleButton.removeAttribute("title");
		} else {
			toggleButton.checked = false; 
			toggleButton.classList.remove("up", "upAndFilter");
			toggleButton.disabled = false;
			toggleButton.setAttribute("title", "Show all");
		}
	}
}
function activateSearchInput(e) {
	let searchInput = e.parentElement;
	searchInput.classList.add("active");
}
function toggleItemList (ev, e) {
	let dropList = e.parentElement.querySelector("div.dropList");
	let dropListItems = dropList.children;
	let toggleButton = e.parentElement.querySelector("button.upDownButton");

	console.log("toggle item list: " + toggleButton.checked);
	
	if (toggleButton.checked) {
		filterItems(e);
	} else {
		dropList.classList.remove("someShowing");
		dropList.classList.add("allShowing");
		setToggleButton(e, true);
	}

	let inputElem = e.parentElement.querySelector("input.visible");
	inputElem.focus();
    ev.stopPropagation();
}
function exactMatch (target, list) {
	for (var i = 0; i < list.length; i++) {
		if (target == list[i].innerText) {
			return true;
		}
	}
	return false;
}
function clearDropList (inputElem, inputBackground, dropList) {
	var elem = inputBackground;
	while (elem.firstChild) elem.removeChild(elem.firstChild);
	inputElem.style.paddingLeft = "10px";
	inputElem.style.width = inputElem.elemWidth + "px";

	let dropListItems = dropList.children;
	for (var i = 0; i < dropListItems.length; i++) {
		dropListItems[i].classList.remove("show", "highlight");
	}
	dropList.classList.remove("allShowing", "someShowing");
}
function filterItems (e) {
	let dropList = e.parentElement.querySelector("div.dropList");
	let dropListItems = dropList.children;
	let inputElem = e.parentElement.querySelector("input.visible");
	let inputBackground = e.parentElement.querySelector("div.inputBackground");

	if (inputElem.value.length == 0 || exactMatch(inputElem.value, dropListItems)) {
		clearDropList(inputElem, inputBackground, dropList);
		setToggleButton(e, false);
		return;
	}
	partial = inputElem.value.toLowerCase();
	let singleValue;
	let n = 0;
	let x0 = 0;
	let i0 = 0;
	for (var i = 0; i < dropListItems.length; i++) {
		let t = dropListItems[i].innerText.toLowerCase();
		let x = t.indexOf(partial);
		if (x != -1) {
			singleValue = dropListItems[i].innerText;
			x0 = x;
			i0 = i;
			n++;
		}
	}
	switch (n) {
	case 0 :
		// No match found
		clearDropList(inputElem, inputBackground, dropList);
	    break;
	case 1 :
   		// Single value found
		var elem = inputBackground;
		while (elem.firstChild) elem.removeChild(elem.firstChild);
        
		var s0 = document.createTextNode(singleValue.substring(0, x0));
		var span0 = document.createElement("span");
		span0.appendChild(s0);
		
		var s1 = document.createTextNode(inputElem.value);
		var span1 = document.createElement("span");
		span1.style.visibility = "hidden";
		span1.appendChild(s1);

		var s2 = document.createTextNode(singleValue.substring(x0 + inputElem.value.length));
		var span2 = document.createElement("span");
		span2.appendChild(s2);
		
		elem.appendChild(span0);
		elem.appendChild(span1);
		elem.appendChild(span2);

		for (var i = 0; i < dropListItems.length; i++) {
			if (i == i0) {
				dropListItems[i].classList.add("show");
			} else {
				dropListItems[i].classList.remove("show", "highlight");
			}
		}
		let offsetLeft = span1.offsetLeft - inputElem.offsetLeft;
		inputElem.style.paddingLeft = offsetLeft + "px";
		inputElem.style.width = (inputElem.elemWidth - offsetLeft + 10) + "px";
		break;
	default :
    	// Multiple values found
		var elem = inputBackground;
		while (elem.firstChild) elem.removeChild(elem.firstChild);
		inputElem.style.paddingLeft = "10px";
		inputElem.style.width = inputElem.elemWidth + "px";

		for (var i = 0; i < dropListItems.length; i++) {
			let t = dropListItems[i].innerText.toLowerCase();
			let x = t.indexOf(partial);
			if (x == -1) {
				dropListItems[i].classList.remove("show", "highlight");
			} else {
				dropListItems[i].classList.add("show");
			}
		}
		break;
	}
	if (n == 0) {
		dropList.classList.remove("allShowing", "someShowing");
	} else if (n == dropListItems.length) {
		dropList.classList.remove("someShowing");
		dropList.classList.add("allShowing");
	} else {
		dropList.classList.remove("allShowing");
		dropList.classList.add("someShowing");
	}
	setToggleButton(e, false);
}
function countShowing (dropList) {
	let dropListItems = dropList.children;

	let n = 0;
	for (var i = 0; i < dropListItems.length; i++) {
		if (dropListItems[i].classList.contains("show")) {
			n++;
		}
	}
	return n;
}
function menuKeyHandler (ev, e) {
	var code = ev.keyCode ? ev.keyCode : ev.which;
	console.log("menu key handler: " + code);
	switch (code) {
	case 27 :			// ESC
	case 37 :			// Left arrow
		var toggleButton = e.parentElement.querySelector("button.upDownButton");
		if (toggleButton.checked) {
			// If drop list is showing, hide it
			toggleItemList(ev, e);
		} else {
            ev.stopPropagation();
		}
		break;
	case 39 :			// Right arrow
		var toggleButton = e.parentElement.querySelector("button.upDownButton");
		console.log("right arrow " + toggleButton.checked);
		if (!toggleButton.checked) {
			// If drop list is not showing, show it
			toggleItemList(ev, e);
	        break;
		}
		// Else treat as a down arrow
		code = 40;
		// DROP THROUGH
	case 38 :			// Up arrow			
	case 40 :			// Down arrow
    	var dropList = e.parentElement.querySelector("div.dropList");
    	var dropListItems = dropList.children;
        
        var i = 0;
        while (i < dropListItems.length) {
        	let dropListItem = dropListItems[i];
            if (dropListItem.classList.contains("highlight")) {
            	dropListItem.classList.remove("highlight");
            	break;
            }
            i++;
        }
        var allShowing = dropList.classList.contains("allShowing");
        if (i < dropListItems.length) {
        	// We found a highlight item
        	(code == 38) ? i-- : i++;
            while (i >= 0 && i < dropListItems.length) {
               	dropListItem = dropListItems[i];
               	if (allShowing || dropListItem.classList.contains("show")) {
                   	dropListItem.classList.add("highlight");
                   	break;
               	}
            	(code == 38) ? i-- : i++;
            }
        } else {
        	// There is no highlight item
        	(code == 38) ? i = dropListItems.length - 1 : i = 0;
            while (i >= 0 && i < dropListItems.length) {
              	dropListItem = dropListItems[i];
               	if (allShowing || dropListItem.classList.contains("show")) {
                   	dropListItem.classList.add("highlight");
                   	break;
               	}
            	(code == 38) ? i-- : i++;
            }
       	}
        ev.stopPropagation();
        break;
	case 9 :			// Tab
		if (!ev.shiftKey) {
			var inputElem = e.parentElement.querySelector("input.visible");
			var inputBackground = e.parentElement.querySelector("div.inputBackground");
    		var dropList = e.parentElement.querySelector("div.dropList");
    		var dropListItems = dropList.children;
        	
        	var i = 0;
        	while (i < dropListItems.length) {
        		let dropListItem = dropListItems[i];
            	if (dropListItem.classList.contains("highlight")) {
            		dropListItem.classList.remove("highlight");
            		break;
            	}
            	i++;
        	}
			if (i < dropListItems.length) {
				// Use the highlighted value as the input value
        		console.log("highlighted: " + dropListItems[i].innerText);
		    	inputElem.value = dropListItems[i].innerText;
			} else {
				// Look for a partial match with only one result
	    		let partial = inputElem.value.toLowerCase();
    			let singleValue;
    			let n = 0;
    			let i0 = 0;
    			for (var i = 0; i < dropListItems.length; i++) {
    				let t = dropListItems[i].innerText.toLowerCase();
    				let x = t.indexOf(partial);
    				if (x != -1) {
    					singleValue = dropListItems[i].innerText;
     					i0 = i;
    					n++;
    				}
    			}
    		
        		if (n == 1) {
        			// We found a matching item (i.e. the partial matches a value)
  		      		console.log("highlighted: " + dropListItems[i0].innerText);
			    	inputElem.value = dropListItems[i0].innerText;
        		}
			}
    		clearDropList(inputElem, inputBackground, dropList);
    		setToggleButton(e, false);
    		let searchInput = document.querySelector(".searchInput.active");
   			searchInput.classList.remove("active");
		}
		break;
	}
}
function setSizeOfSearchInput () {
	let dropList = document.querySelector("div.dropList");
	dropList.classList.add("calcSize");
	let inputElem = dropList.parentElement.querySelector("input.visible");
	let inputBackground = dropList.parentElement.querySelector("div.inputBackground");
	elemWidth = dropList.clientWidth;   // width with padding

	// Remove padding width
	let computedStyle = getComputedStyle(inputElem);
	elemWidth -= parseFloat(computedStyle.paddingLeft) + parseFloat(computedStyle.paddingRight);
	
	inputElem.style.width = elemWidth + "px";
	inputBackground.style.width = elemWidth + "px";
	inputElem.elemWidth = elemWidth;
	
	let upDownButton = dropList.parentElement.querySelector("button.upDownButton");
	upDownButton.style.left = dropList.offsetWidth + "px";
	let inputHeight = inputElem.offsetHeight;
	upDownButton.style.width = inputHeight + "px";
	upDownButton.style.height = inputHeight + "px";
	dropList.classList.remove("calcSize");
}
function selectItem (e) {
	let topDiv = e.parentElement.parentElement;
	let inputElem = topDiv.querySelector("input.visible");
	let inputBackground = topDiv.querySelector("div.inputBackground");
	let dropList = e.parentElement;
	let dropListItems = dropList.children;
	
	// Remove any highlight
	console.log("clicked on: " + e.innerText);
	let highlighted = dropList.querySelector("div.highlight");
	if (highlighted) {
		console.log("removed hightlight on: " + e.innerText);
		highlighted.classList.remove("highlight");
	}
	inputElem.value = e.innerText;
	clearDropList(inputElem, inputBackground, dropList);
	setToggleButton(e.parentElement, false);
}
//function menuMouseWheelHandler (ev) {
//	var delta = Math.max(-1, Math.min(1, (ev.wheelDelta || -ev.detail)));
//	console.log("mouse wheel handler: delta " + delta);
//	return false;
//}
  </script>
</head>
<body onload="setSizeOfSearchInput()">
    <div class="searchInput">
      <input class="visible" type="text" oninput="filterItems(this)" onfocus="activateSearchInput(this)" onkeydown="menuKeyHandler(event,this)">
      <input class="hidden" name="partyName" type="text">
      <div class="inputBackground">&nbsp;</div>
      <button class="upDownButton" onclick="toggleItemList(event,this)" tabindex="-1" title="Show all"></button>
      <div class="dropList">
        <div data-value="2" onclick="selectItem(this)">Australian Foundation Investment Company</div>
        <div data-value="3" onclick="selectItem(this)">BHP Billiton</div>
        <div data-value="4" onclick="selectItem(this)">Commonwealth Bank of Australia</div>
        <div data-value="1" onclick="selectItem(this)">Qantas Airways</div>
        <div data-value="5" onclick="selectItem(this)">Telstra Corporation</div>
      </div>
    </div>
  
<script>
// Close the dropdown if the user clicks outside of it
window.onclick = function(event) {
	let searchInput = document.querySelector(".searchInput.active");
	if (searchInput) {
		if (event.target.matches(".searchInput.active input.visible")) {
			// On the search input field, so do nothing
			return;
		}
	  	if (event.target.matches(".searchInput.active div.dropList")) {
		  	// On the drop down list, so do nothing
		  	return;
	  	}
		searchInput.classList.remove("active");
	}
//   	if (searchInputId) {
// 		if (event.target.matches(".searchInput button.upDownButton")) {
// 			// On any of the search input fields, so do nothing
// 			return;
// 		}
// 		if (event.target.matches(".searchInput input")) {
// 			// On the search input field, so do nothing
// 			return;
// 		}
// 	  	if (event.target.matches(".searchInput div.dropList")) {
// 		  	// On the drop down list, so do nothing
// 		  	return;
// 	  	}
// 		let searchInput = document.getElementById(id);
// 		searchInput.classList.remove("active");
// 	}
}
</script>
</body>
</html>
 